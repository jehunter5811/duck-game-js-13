<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <link rel="manifest" href="manifest.json" />
  <!-- ios support -->
  <link rel="apple-touch-icon" href="DUCK.png" />
  <link rel="apple-touch-icon" href="DUCK.png" />
  <link rel="apple-touch-icon" href="DUCK.png" />
  <link rel="apple-touch-icon" href="DUCK.png" />
  <link rel="apple-touch-icon" href="DUCK.png" />
  <link rel="apple-touch-icon" href="DUCK.png" />
  <link rel="apple-touch-icon" href="DUCK.png" />
  <link rel="apple-touch-icon" href="DUCK.png" />
  <meta name="apple-mobile-web-app-status-bar" content="#db4938" />
  <meta name="theme-color" content="#db4938" />
  <title>Duck Game</title>
  <style>
    body,
    html {
      margin: 0;
      overflow-x: hidden;
      -ms-overflow-style: none; /* IE and Edge */
      scrollbar-width: none; /* Firefox */
      touch-action: manipulation;
      -webkit-user-select: none;
    }
    body::-webkit-scrollbar {
      display: none;
    }
    #world {
      width: 600px;
      height: 3000px;
      background: lightblue;
      margin: auto;
      overflow-y: hidden;
      overflow-x: hidden;
    }
    #controls {
      position: fixed;
      z-index: 1024;
      bottom: 70px;
      opacity: 0.3;
      right: 20px;
    }
    #up {
      position: absolute;
      bottom: 100px;
      height: 60px;
      width: 60px;
      right: 100px;
      background: blue;
    }
    #right {
      position: absolute;
      bottom: 50px;
      height: 60px;
      width: 60px;
      right: 25px;
      background: blue;
    }
    #left {
      position: absolute;
      bottom: 50px;
      height: 60px;
      width: 60px;
      right: 175px;
      background: blue;
    }
    #down {
      position: absolute;
      bottom: 0px;
      height: 60px;
      width: 60px;
      right: 100px;
      background: blue;
    }
    .egg {
      width: 30px;
      height: 30px;
      border-radius: 36% 64% 59% 41% / 46% 40% 60% 54%;
      background: white;
      box-shadow: -5px 5px 10px 3px rgba(0, 0, 0, 0.15), inset 5px 5px 0 #f7f7f7;
      animation: pulse-white 2s infinite;
    }
    .egg:before {
      content: "";
      width: 20px;
      height: 20px;
      background: #faca3b;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: inset -5px -10px 0 #f9bd09;
    }
    .container{
      display: flex;
      justify-content: center;
      height: 100%;
      width: 100%;
      position: absolute;
    }
    /* TREE CSS */
    .tree{
      background: #5d3010;
      height: 100%;
      width: 13vw;
      position: relative;
    }
    .tree .trunk{
      width: 25%;
      position: absolute;
    }
    .tree .upper.trunk{
      height: 30%;
      top: 0;
    }
    .tree .lower.trunk{
      height: 70%;
      bottom: 0;
    }
    .tree .right.trunk{
      right: 0;
    }
    .tree .left.trunk{
      left: 0;
    }
    .tree .upper.left.trunk{
      border-top-right-radius: 100%;
    }
    .tree .upper.right.trunk{
      border-top-left-radius: 100%;
    }
    .tree .lower.left.trunk{
      border-bottom-right-radius: 100%;
    }
    .tree .lower.right.trunk{
      border-bottom-left-radius: 100%;
    }
    .shake {
      /* Start the shake animation and make the animation last for 0.5 seconds */
      animation: shake 0.5s;

      /* When the animation is finished, start again */
      animation-iteration-count: infinite;
    }
    @keyframes pulse-white {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
      }
    }
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
  </style>
</head>
<body>
  <div id="world">
    <div style="display: none" id="controls">
      <div id="up"></div>
      <div id="down"></div>
      <div id="left"></div>
      <div id="right"></div>
    </div>
    <div id="game">
    </div>
  </div>
  <script>
    const FPS = 15;
    let game;
    let currentLevel = 0;
    let MAX_WIDTH = 600;
    const MAX_HEIGHT = 3000;
    const BACKGROUND_WIDTH = 216;
    const PLAYER_SPEED = 3;
    const FRICTION = 0.8;
    const GRAVITY = 0.4;
    const ITEM_GRAVITY = 0.2;
    const JUMP_POWER = 2.5;
    let GROUNDED = true;
    let JUMPING = false;
    let player;
    const SPRITE_HEIGHT = 25;
    const SPRITE_WIDTH = 25;
    const SCALE = 1;
    let keys = [];
    let playerVelX = 0;
    let playerVelY = 0;
    let eggVelY = 0;
    let itemVelY = 0;
    let levels = [];
    let platforms = [];
    let eggs = [];    
    const MAX_EGG_TIMER = 250;
    let eggTimer = MAX_EGG_TIMER;
    let pause = false;
    const cycleLoop = [10, 11, 12, 13, 14, 15];
    const eggLoop = [9, 8, 7, 6, 5, 4];
    const jumpLoop = [4, 3, 2, 1];
    let eggLoopIndex = 0;
    let currentLoopIndex = 0;
    let facingRight = true;
    let jumpingOff = false;
    let img = new Image();
    let frame = 0;
    let layingEgg = false;
    let eggTimerBar;
    let droppingItems = false;
    let dropCount = 0;
    const maxDropCount = 100;
    let droppedItems = [];

    const levelCompleteText = [
      "You flapped and hopped your way to your first feather! Quack...or tap...anywhere to continue.",
    ];

    window.addEventListener("load", function () {
      const isMobile = () => {
        if (
          navigator.userAgent.match(/Android/i) ||
          navigator.userAgent.match(/BlackBerry/i) ||
          navigator.userAgent.match(/iPhone|iPod/i) ||
          navigator.userAgent.match(/Opera Mini/i) ||
          navigator.userAgent.match(/IEMobile/i) ||
          navigator.userAgent.match(/WPDesktop/i)
        ) {
          return true;
        } else {
          return false;
        }
      };

      const world = document.getElementById("world");

      if (isMobile()) {
        MAX_WIDTH = window.innerWidth;

        world.style.width = `${window.innerWidth}px`;
        const controls = document.getElementById("controls");
        controls.style.display = "block";

        const up = document.getElementById("up");
        const down = document.getElementById("down");
        const left = document.getElementById("left");
        const right = document.getElementById("right");

        controls.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
          },
          false
        );

        up.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          keys[38] = true;
        });
        down.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          keys[40] = true;
        });
        right.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          keys[39] = true;
        });
        left.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          keys[37] = true;
        });

        document.addEventListener("pointerup", (e) => {
          e.preventDefault();
          keys[39] = false;
          keys[38] = false;
          keys[37] = false;
          keys[40] = false;
        });
      }

      world.style.margin = '0px';
      world.style.padding = '0px';

      const navButtons = document.createElement("div");
      navButtons.style.height = "75px";
      navButtons.style.width = MAX_WIDTH;
      navButtons.style.margin = "auto";
      navButtons.style.position = "fixed";
      navButtons.style.top = 0;
      navButtons.style.display = "flex";
      navButtons.style.alignItems = "center";
      navButtons.style.zIndex = 1024;
      navButtons.style.justifyContent = "space-between";
      const refresh = document.createElement("button");
      refresh.innerText = "Reload";
      refresh.onclick = () => handleReload();
      const pauseButton = document.createElement("button");
      pauseButton.innerText = pause ? "Start" : "Pause";
      pauseButton.onclick = () => handlePause();
      const playGameButton = document.createElement("button");
      playGameButton.innerText = "Play Game (**Plays Music**)";
      playGameButton.onclick = () => handlePlayMusic();
      navButtons.appendChild(refresh);
      navButtons.appendChild(pauseButton);
      navButtons.appendChild(playGameButton);
      world.appendChild(navButtons);

      levels = [
        {
          level: 0,
          platforms: [
            {
              //  Ground platform
              x: 0,
              y: MAX_HEIGHT - 175,
              width: MAX_WIDTH,
              height: 175,
              id: "pond",
              background: 'color', 
              color: 'blue'
            },
            {
              x: 150,
              y: MAX_HEIGHT - 229,
              width: 80,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "2",
            },
            {
              x: 105,
              y: MAX_HEIGHT - 265,
              width: 35,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "3",
            },
            {
              x: 155,
              y: MAX_HEIGHT - 290,
              width: 120,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "4",
            },
            {
              x: 110,
              y: MAX_HEIGHT - 340,
              width: 130,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "5",
            },
            {
              x: 65,
              y: MAX_HEIGHT - 487,
              width: 190,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "6",
            },
            {
              x: 225,
              y: MAX_HEIGHT - 530,
              width: 75,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "7",
            },
            {
              x: 140,
              y: MAX_HEIGHT - 540,
              width: 50,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "8",
            },
            {
              x: 180,
              y: MAX_HEIGHT - 580,
              width: 95,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "9",
            },
            {
              x: 40,
              y: MAX_HEIGHT - 605,
              width: 115,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "10",
            },
            {
              x: 180,
              y: MAX_HEIGHT - 632,
              width: 40,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "11",
            },
            {
              x: 138,
              y: MAX_HEIGHT - 682,
              width: 33,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "12",
            },
            {
              x: 210,
              y: MAX_HEIGHT - 692,
              width: 27,
              height: 10,
              background: "color",
              color: "#6b561d",
              id: "13",
            },
            {
              x: 163,
              y: MAX_HEIGHT - 745,
              width: 135,
              height: 10,
              background: "color",
              color: "red",
              id: "14",
            },            
            {
              //  Embankment
              x: 0, 
              y: MAX_HEIGHT - 1350,
              width: MAX_WIDTH, 
              height: 500,
              walking: true,
              background: "color",
              color: 'yellow'
            }, 
            {
              x: 0, 
              y: MAX_HEIGHT - 1370,
              width: MAX_WIDTH, 
              height: 20,
              background: "color",
              color: 'brown'
            }
          ],
        },
        {
          level: 1,
          platforms: [
            {
              //  Ground platform
              x: 0,
              y: MAX_HEIGHT - 20,
              width: MAX_WIDTH,
              height: 50,
              velY: 0,
              background: "color",
              color: "blue",
              id: "1",
            },
            {
              x: 20,
              y: MAX_HEIGHT - 200,
              width: 100,
              height: 20,
              velY: 0,
              id: "2",
            },
          ],
        },
      ];
    });
    window.onload = () => {
      img.src = "sprites.png";
      img.onload = () => {
        console.log("Sprite sheet loaded");
        //  Get level/checkpoint
        currentLevel = localStorage.getItem("level")
          ? parseInt(localStorage.getItem("level"), 10)
          : 0;
        loadLevel(currentLevel);
      };
    };

    const loadLevel = (level) => {
      const eggTimerBarContainer = document.createElement('div');
      eggTimerBarContainer.style.position = 'fixed';
      eggTimerBarContainer.style.zIndex = '2000';
      eggTimerBarContainer.style.top = '50px';
      eggTimerBarContainer.style.width = `${MAX_WIDTH/2 - 10}px`;
      eggTimerBarContainer.style.height = '20px';
      eggTimerBarContainer.style.border = '1px solid #282828';

      eggTimerBar = document.createElement('div');
      eggTimerBar.style.margin ='0px';
      eggTimerBar.style.height = '100%';
      eggTimerBar.style.width = '100%';
      eggTimerBar.style.background = 'yellow';
      eggTimerBar.style.opacity = '0.5';
      eggTimerBarContainer.appendChild(eggTimerBar);      

      player = document.createElement('div');
      player.style.height = `${SPRITE_HEIGHT * SCALE}px`
      player.style.width = `${SPRITE_WIDTH * SCALE}px`;
      player.style.backgroundImage = `url(${img.src})`
      player.style.backgroundPosition = `0px ${SPRITE_HEIGHT * SCALE}px `
      player.style.position = 'absolute';
      //  Read in the number of platforms
      const thisLevel = levels[level];
      platforms = thisLevel.platforms;

      //  Attach player game view
      game = document.getElementById("world");
      game.style.position = "relative";
      game.appendChild(player);

      game.appendChild(eggTimerBarContainer);

      player.style.bottom = `${(100 * (MAX_WIDTH/BACKGROUND_WIDTH)) - 2}px`;
      player.style.left = "100px";
      player.style.zIndex = "1024";

      drawPlatforms();
      pause = false;
      requestAnimationFrame(gameLoop);
    };

    const dropItem = (itemType) => {
      const item = document.createElement('div');
      item.style.width = '25px';
      item.style.height = '25px';
      item.style.position = 'absolute';
      item.style.zIndex = 2000;
      item.style.left = `${Math.floor(Math.random() * MAX_WIDTH) + 1}px`;
      item.style.bottom = `${parseInt(player.style.bottom.split('px')[0], 10) + 600}px`;
      item.style.backgroundImage = 'url(acorn.png)';
      item.style.backgroundSize = 'cover';
      
      item.setAttribute('class', 'dropped-item')
      game.appendChild(item);      
    }

    const drawFrame = (frameX, frameY) => {  
      const x = `${SPRITE_WIDTH * SCALE * frameX}px`;
      const y = `${SPRITE_HEIGHT * SCALE * frameY}px`;
      if(player) {
        player.style.backgroundPosition = `${x} ${y}`;
      }   
    };

    const timeoutPromise = (time) => {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          resolve();
        }, time)
      })
    }

    const jump = async(dir) => {
      if(dir === 'right') {
        for(fr of jumpLoop) {     
          drawFrame(fr, 0);
          await timeoutPromise(100);
        }
      } else {
        for(fr of jumpLoop) {     
          drawFrame(fr, 1);
          await timeoutPromise(100);
        }        
      }      
    }

    const layEgg = async () => {
      if(eggTimer === MAX_EGG_TIMER) {
        eggTimer = 0;
        eggTimerBar.style.width = '0%';
        layingEgg = true;
        const dir = facingRight ? 0 : 1;
        for(fr of eggLoop) {     
          drawFrame(fr, dir);
          await timeoutPromise(100);
        }
        layingEgg = false;
        eggLoopIndex = 0;          
        const egg = document.createElement("div");
        egg.style.height = `${SPRITE_WIDTH}px`;
        egg.style.width = `${SPRITE_HEIGHT}px`;
        egg.style.background = "url(sprites.png)";
        const x = `${SPRITE_WIDTH * SCALE * 16}px`;
        const y = `${SPRITE_HEIGHT * SCALE}px`;
        egg.style.backgroundPosition = `${x} ${y}`
        egg.style.position = "absolute";
        egg.style.left = player.style.left;
        egg.style.bottom = player.style.bottom;
        egg.setAttribute("id", "egg-1");
        eggs.push(egg);
        game.appendChild(egg);
        playerVelY = -PLAYER_SPEED * (JUMP_POWER + 0.5); 
      }      
    }

    const handleReload = () => {
      wipeGame();
      currentLevel = localStorage.getItem("level")
        ? parseInt(localStorage.getItem("level"), 10)
        : 0;
      loadLevel(currentLevel);
    };

    const wipeGame = () => {
      pause = true;
      if (pause && game) {
        while (game.firstChild) {
          game.removeChild(game.firstChild);
        }
      }
    };

    const handlePause = () => {
      pause = !pause;
      if (!pause) {
        gameLoop();
      }
    };

    const handlePlayMusic = () => {      
      // Audio Library
      let zzfxM = (f,n,o,t=125)=>{let z,e,l,r,g,h,x,a,u,c,d,i,m,p,G,M,R=[],b=[],j=[],k=0,q=1,s={},v=zzfxR/t*60>>2;for(;q;k++)R=[q=a=d=m=0],o.map((t,d)=>{for(x=n[t][k]||[0,0,0],q|=!!n[t][k],G=m+(n[t][0].length-2-!a)*v,e=2,r=m;e<x.length+(d==o.length-1);a=++e){for(g=x[e],u=c!=(x[0]||0)|g|0,l=0;l<v&&a;l++>v-99&&u?i+=(i<1)/99:0)h=(1-i)*R[p++]/2||0,b[r]=(b[r]||0)+h*M-h,j[r]=(j[r++]||0)+h*M+h;g&&(i=g%1,M=x[1]||0,(g|=0)&&(R=s[[c=x[p=0]||0,g]]=s[[c,g]]||(z=[...f[c]],z[2]*=2**((g-12)/12),zzfxG(...z))))}m=G});return[b,j]};
      let zzfx = (...t)=>zzfxP(zzfxG(...t));
      let zzfxP = (...t)=>{let e=zzfxX.createBufferSource(),f=zzfxX.createBuffer(t.length,t[0].length,zzfxR);t.map((d,i)=>f.getChannelData(i).set(d)),e.buffer=f,e.connect(zzfxX.destination),e.start();return e}
      let zzfxG = (a=1,t=.05,h=220,M=0,n=0,s=.1,i=0,r=1,o=0,z=0,e=0,f=0,m=0,x=0,b=0,d=0,u=0,c=1,G=0,I=zzfxR,P=99+M*I,V=n*I,g=s*I,j=G*I,k=u*I,l=2*Math.PI,p=(a=>0<a?1:-1),q=P+j+V+g+k,v=(o*=500*l/I**2),w=(h*=(1+2*t*Math.random()-t)*l/I),y=p(b)*l/4,A=0,B=0,C=0,D=0,E=0,F=0,H=1,J=[])=>{for(;C<q;J[C++]=F)++E>100*d&&(E=0,F=A*h*Math.sin(B*b*l/I-y),F=p(F=i?1<i?2<i?3<i?Math.sin((F%l)**3):Math.max(Math.min(Math.tan(F),1),-1):1-(2*F/l%2+2)%2:1-4*Math.abs(Math.round(F/l)-F/l):Math.sin(F))*Math.abs(F)**r*a*zzfxV*(C<P?C/P:C<P+j?1-(C-P)/j*(1-c):C<P+j+V?c:C<q-k?(q-C-k)/g*c:0),F=k?F/2+(k>C?0:(C<q-k?1:(C-q)/k)*J[C-k|0]/2):F),A+=1-x+1e9*(Math.sin(C)+1)%2*x,B+=1-x+1e9*(Math.sin(C)**2+1)%2*x,h+=o+=500*z*l/I**3,H&&++H>f*I&&(h+=e*l/I,w+=e*l/I,H=0),m&&++D>m*I&&(h=w,o=v,D=1,H=H||1);return J};
      // Audio Volume
      let zzfxV = .1;
      // Audio Sample Rate
      let zzfxR = 44100;
      // Play the song (returns a AudioBufferSourceNode)
      // Common Audio Context
      let zzfxX = new(top.AudioContext||webkitAudioContext);
      let song = [[[1.8,0,72,,,.2,,4,-2,6,50,.15,,6],[,0,655,,,.09,3,1.65,,,,,.02,3.8,-.1,,.2],[1.2,0,23,,,.2,3,4,,,3,.9,.05,],[1.5,0,740,,,.15,2,.2,-.1,-.15,9,.02,,.1,.12,,.06]],[[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,,,,,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,25,,,25,,25,25,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,]],[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,8,8,8,5,13],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,,,,,,,,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[1,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,13,13,13,13,13,13,13,13]],[[3,-1,13,13,13,8,13,,13,15,17,17,15,13,20,20,18,17,18,,,,17,,15,,,,17,,18,,22,22,22,,18,,,,25,25,25,,22,,,18,20,22,20,,,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,11,,23,,11,11,23,11,,11,23,11,11,11,23,,10,,22,,10,10,22,10,,10,22,10,10,6,8,10,20,25,20,20,25,20,,20,25,20,20,20,25,,20,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,15,13,,17,15,13,,15,,,,10,13,15,10,13,15,10,13,15,10,13,15,12,,,,,,8,15,,,,,17,15,13,8,13,,,,,,10,8,,20,20,20,20,20,20,20],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,15,,27,,15,15,27,15,,15,27,15,15,15,27,32,20,,32,,20,20,32,20,,20,32,20,20,20,32,,13,,25,,13,13,25,20,,20,32,20,20,20,32,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[2,-1,13,,25,25,13,,25,25,13,,25,25,13,,25,25,15,,27,27,15,,27,27,15,,27,27,15,,27,27,20,,32,32,20,,32,32,20,,32,32,20,,32,32,13,,25,25,13,,25,25,20,,32,32,20,,32,34],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,25,,,25,,,,25,25,25,25,25],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13,,13,13,13,13,13,13,13]]],[0,1,2,2,3,3,2,2,4,4,5,6,6,7,2,2,3],,];

      let mySongData = zzfxM(...song);
      let myAudioNode = zzfxP(...mySongData);
      // requestAnimationFrame(gameLoop);
    }



    const drawCollectible = (type) => {
      switch (type) {
        case "feather":
          const feather = document.createElement("svg");
          feather.setAttribute("class", "egg");
          return feather;
        default:
          return;
      }
    };

    const drawPlatforms = () => {
      platforms.forEach((platform) => {
        const newPlatform = document.createElement("div");
        if (platform.background === "none") {
          newPlatform.style.background = "none";
        } else if (platform.background === "border") {
          newPlatform.style.border = "0.5px solid #000";
        } else if (platform.background === "color") {
          newPlatform.style.background = platform.color;
        } else {
          newPlatform.style.background = "#000";
        }
        newPlatform.style.width = `${platform.width}px`;
        newPlatform.style.height = `${platform.height}px`;
        newPlatform.style.position = "absolute";
        newPlatform.style.top = `${platform.y}px`;
        newPlatform.style.left = `${platform.x}px`;        
        newPlatform.setAttribute("id", platform.id);

        game.appendChild(newPlatform);

        if(platform.walking) {
          const treeSection = document.createElement('div');
          treeSection.setAttribute('class', 'container')
          const tree = document.createElement('div');
          tree.setAttribute('class', 'tree');
          const treeUpperRight = document.createElement('div');
          treeUpperRight.setAttribute('class', 'trunk upper right')
          const treeUpperLeft = document.createElement('div');
          treeUpperLeft.setAttribute('class', 'trunk upper left')
          const treeLowerRight = document.createElement('div');
          treeLowerRight.setAttribute('class', 'trunk lower right')
          const treeLowerLeft = document.createElement('div');
          treeLowerLeft.setAttribute('class', 'trunk lower left');

          tree.appendChild(treeUpperLeft)
          tree.appendChild(treeUpperRight)
          tree.appendChild(treeLowerLeft)
          tree.appendChild(treeLowerRight)
          treeSection.appendChild(tree);
          treeSection.style.position = 'absolute';
          treeSection.style.bottom = `${platform.y - 300}px`;
          game.appendChild(treeSection);
        }

        //  Check for collectibles
        if (platform.collectible) {
          const collectible = drawCollectible(platform.collectible.type);
          collectible.setAttribute("id", platform.collectible.id);
          collectible.style.position = "absolute";
          collectible.style.left = `${platform.x + platform.width / 2}px`;
          collectible.style.top = `${platform.y - platform.height - 10}px`;
          game.appendChild(collectible);
        }
      });
    };
    const detectOverlap = (() => {
      const getPositions = (elem) => {
        let pos = elem.getBoundingClientRect();
        return [
          [pos.left, pos.right],
          [pos.top, pos.bottom],
        ];
      };
      const comparePositions = (p1, p2) => {
        let r1, r2;
        if (p1[0] < p2[0]) {
          r1 = p1;
          r2 = p2;
        } else {
          r1 = p2;
          r2 = p1;
        }
        return r1[1] > r2[0] || r1[0] === r2[0];
      };
      return (a, b) => {
        let pos1 = getPositions(a),
          pos2 = getPositions(b);
        return (
          comparePositions(pos1[0], pos2[0]) &&
          comparePositions(pos1[1], pos2[1])
        );
      };
    })();

    const handleNextLevel = (current) => {
      pause = true;
      const successWrapper = document.createElement("div");
      successWrapper.style.width = `${MAX_WIDTH}px`;
      successWrapper.style.position = "fixed";
      successWrapper.style.top = "50px";
      const successText = document.createElement("h3");
      successText.innerText = levelCompleteText[current];
      successText.style.textAlign = "center";
      successText.style.fontFamily = "PressStart2P";
      successWrapper.appendChild(successText);
      game.appendChild(successWrapper);
      document.addEventListener("pointerdown", (e) => {
        for (const platform of platforms) {
          const p = document.getElementById(platform.id);
          p.remove();
          successText.remove();
          player.style.position = "absolute";
          player.style.bottom = "50px";
          player.style.left = "100px";
        }
        eggs.forEach((egg) => {
          egg.remove();
        });
        if (pause) {
          currentLevel++;
          // localStorage.setItem('level', JSON.stringify(currentLevel));
          platforms = levels[currentLevel].platforms;
          drawPlatforms();
          pause = false;
          gameLoop();
        }
      });
    };

    const gameLoop = async () => {
      if (!pause) {
        if(eggTimer < MAX_EGG_TIMER) {
          eggTimer++;
          eggTimerBar.style.width = `${eggTimer/MAX_EGG_TIMER * 100}%`;
        }

        if(droppingItems) {
          const droppedItems = document.getElementsByClassName('dropped-item');
          if(!droppedItems || droppedItems.length === 0) {
            dropItem('acorn');
            dropCount = 0;
          }
        }

        const jumpKey = keys[38] || keys[32] || keys[87];
        const rightKey = keys[39] || keys[68];
        const leftKey = keys[37] || keys[65];
        const layEggKey = keys[40] || keys[83];

        playerVelX *= FRICTION;

        if (!jumpingOff && !layingEgg) {
          playerVelY += GRAVITY;
        } else {
          if(playerVelY > 0) {
            playerVelY--;
          }
        }

        let touching = [];

        platforms.forEach((platform) => {
          const p = document.getElementById(platform.id);
          const a = player.getBoundingClientRect();
          const b = p.getBoundingClientRect();

          if (detectOverlap(player, p)) {           
            if (!(a.bottom > b.top + platform.height)) {
              if(platform.walking === true) {
                jumpingOff = true;
                droppingItems = true;
              } else {
                jumpingOff = false;
                droppingItems = false;
                touching.push(platform.id);

                if (a.bottom > b.top && platform.id !== "1" && !jumpingOff) {
                  player.style.bottom = `${
                    parseInt(player.style.bottom.split("px")[0]) +
                    (a.bottom - b.top)
                  }px`;
                  playerVelY = 0;
                }
              }
            }
          }
        });
        platforms
          .filter((p) => p.collectible !== undefined)
          .forEach((collect) => {
            const item = document.getElementById(collect.collectible.id);

            const touching = detectOverlap(player, item);
            //  Check if it's the main feather
            if (touching && item.id === "main_feather") {
              //  Trigger next level handling
              item.remove();
              handleNextLevel(currentLevel);
            } else {
              //  Save count of collectible type
            }
          });
        
        const droppedItems = document.getElementsByClassName('dropped-item');
        if(droppedItems && droppedItems.length > 0) {
          for(const item of droppedItems) {
            const touching = detectOverlap(player, item);
            if(touching) {
              navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;
              if(navigator.vibrate) {
                navigator.vibrate(1000);
              }              
              world.classList.add('shake');
              await timeoutPromise(100);
              world.classList.remove('shake');
              item.remove();
            }

            item.style.bottom = `${
              parseInt(item.style.bottom.split("px")[0], 10) - itemVelY
            }px`;
            if (
              parseInt(item.style.bottom.split("px")[0], 10) < -window.innerHeight
            ) {            
              item.remove();
              itemVelY = 0;
            }
            itemVelY += ITEM_GRAVITY;
          }
        }      

        eggs.forEach((egg) => {
          egg.style.bottom = `${
            parseInt(egg.style.bottom.split("px")[0], 10) - eggVelY
          }px`;
          if (
            parseInt(egg.style.bottom.split("px")[0], 10) < -window.innerHeight
          ) {
            eggs = [];
            eggVelY = 0;
            egg.remove();
          }
          eggVelY += GRAVITY;
        });

        if (touching.length) {
          GROUNDED = true;
          JUMPING = false;
        }

        if (GROUNDED && !jumpingOff) {
          playerVelY = 0;
        } else if (jumpingOff) {
          playerVelY *= FRICTION;
        }

        if (layEggKey) {
          if (!jumpingOff) {         
            layEgg();
          } else if (jumpingOff) {
            playerVelY++;
            if (facingRight && playerVelX < PLAYER_SPEED) {
              playerVelX++;
            } else if (!facingRight && playerVelX > -PLAYER_SPEED) {
              playerVelX--;
            }
          }
        }

        if (jumpKey && rightKey) {
          facingRight = true;
          if (!JUMPING && GROUNDED && !jumpingOff) {
            GROUNDED = false;
            playerVelY = -PLAYER_SPEED * JUMP_POWER;
          }
          if (playerVelX < PLAYER_SPEED) {
            playerVelX++;
          }

          if(!layingEgg && !JUMPING) {
            JUMPING = true;
            jump('right');
          }
        } else if (jumpKey && leftKey) {
          facingRight = false;
          if (!JUMPING && GROUNDED && !jumpingOff) {
            GROUNDED = false;
            playerVelY = -PLAYER_SPEED * JUMP_POWER;
          }
          if (playerVelX > -PLAYER_SPEED) {
            playerVelX--;
          }          

          if(!layingEgg && !JUMPING) {
            jump('left');
          }          
        } else if (jumpKey) {
          if (!JUMPING && GROUNDED && !jumpingOff) {
            GROUNDED = false;
            playerVelY = -PLAYER_SPEED * JUMP_POWER;
          }

          if(!layingEgg && !JUMPING) {
            JUMPING = true;

            const dir = facingRight ? 'right' : 'left';
            jump(dir);
          }          
        } else if (rightKey) {
          facingRight = true;
          if (playerVelX < PLAYER_SPEED) {
            playerVelX++;
            if (jumpingOff) {
              playerVelY--;
            }
          }
          if(!layingEgg && (!JUMPING || jumpingOff)) {            
            drawFrame(cycleLoop[currentLoopIndex], 0);           
          }          
        } else if (leftKey) {
          facingRight = false;
          if (playerVelX > -PLAYER_SPEED) {
            playerVelX--;
            if (jumpingOff) {
              playerVelY--;
            }
          }
          if(!layingEgg && (!JUMPING || jumpingOff)) {
            drawFrame(cycleLoop[currentLoopIndex], 1);
          }          
        } else {
          if(facingRight) {
            if(!layingEgg && !JUMPING) {
              drawFrame(15, 0);  
            }            
          } else {
            if(!layingEgg && !JUMPING) {
              drawFrame(15, 1);  
            }            
          }    
        }

        if(rightKey || leftKey) {
          frame++
          if(frame >= FPS) {
            frame = 0;
            currentLoopIndex++;  
          } 
        }

        if (currentLoopIndex >= cycleLoop.length) {
          currentLoopIndex = 0;
        }

        player.style.left = `${
          parseInt(player.style.left.split("px")[0], 10) + playerVelX
        }px`;
        player.style.bottom = `${
          parseInt(player.style.bottom.split("px")[0], 10) - playerVelY
        }px`;

        GROUNDED = false;

        if (player) {
          // player.scrollIntoView();
          window.scrollTo(0, player.offsetTop - 200);
        }

        if (parseInt(player.style.left.split("px")[0], 10) > MAX_WIDTH) {
          player.style.left = "0px";
        }

        if (parseInt(player.style.left.split("px")[0], 10) < -10) {
          player.style.left = `${MAX_WIDTH}px`;
        }

        requestAnimationFrame(gameLoop);
      }
    };

    document.body.addEventListener("keydown", function (e) {
      e.target.click();
      keys[e.keyCode] = true;
    });

    document.body.addEventListener("keyup", function (e) {
      keys[e.keyCode] = false;
    });

    document.addEventListener("gesturestart", function (e) {
      e.preventDefault();
    });

    document.addEventListener("gesturechange", function (e) {
      e.preventDefault();
    });

    document.addEventListener("gestureend", function (e) {
      e.preventDefault();
    });
  </script>
  <script>
    const staticDuckGame = "duck-game";
    const assets = ["/", "/index.html"];

    self.addEventListener("install", (installEvent) => {
      installEvent.waitUntil(
        caches.open(staticDevCoffee).then((cache) => {
          cache.addAll(assets);
        })
      );
    });

    self.addEventListener("fetch", (fetchEvent) => {
      fetchEvent.respondWith(
        caches.match(fetchEvent.request).then((res) => {
          return res || fetch(fetchEvent.request);
        })
      );
    });
  </script>
</body>
